> Allplayer是一个跨平台的媒体播放库，采用libMediaService网络库接收流，ffmpeg进行解码，SDL等渲染。

[TOC]

## 一、Allplayer 简介

- 支持windows,linux,ios,android平台
- 支持各种媒体文件，本地文件
- 拓展了RTSP 协议以适配更多method

## 二、主要功能说明

### 全局配置

- 日志路径

- 日志等级

### 实时浏览

1. 创建bussiness并播放实时流
   - 是否开启画质优先，画质优先时的缓冲大小
   - 倍速参数是scale还是speed
   - 是否启用硬件解码(默认启用硬件渲染)
2. 停止实时流
3. 暂停、恢复

### 录像回放

1. 创建bussiness并播放录像
2. 停止录像回放
3. 录像回放暂停、恢复
4. vrc控制

### 录像下载

1. 录像下载、暂停、继续 

### 播放设置(实时浏览和录像回放)

1. 电子放大
2. 本地录像
3. 抓拍
4. 音量控制
5. 媒体信息
6. 语音对讲

### 支持拼接流

1. 实时拼接流

2. 拼接流录像

### 其他常规视频格式

1. 创建bussiness并播放
2. 停止播放
3. 获取缩略图
4. 暂停、恢复
5. 跳转(只对本地文件有效)

## 三、版本更新

#### 当前版本信息：

版本名:    **5.1.1**

commit:  **5317b02490c4192bc1ec8edcdcb7fd1eaa31289b**

#### 

### 5.10

#### feat:

1. 合并V4.4.7版本代码： 修复录像下载H265、下载慢、parser在close时未判空、音频模块重构，rtmp语音对讲等问题

2. 支持IVS平台的录像倒放

##### fix:

1. H265花屏问题
2. 修复无缝切换是没有将format置空，偶现导致崩溃。
3. 增加H265异常流分片判断，增加异常流处理机制。
4. 适配录像下载vcr_control接口
5. avs平台sdp信息没有U描述的情况下使用rtsp url加trackID后setup

#### 5.0.0

##### feat:

1. 渲染线程和解码线程分离，优化视频卡顿

2. 录像回放不存在画质优先设置

##### fix:

1. 声音播放异常

---------------------------------------------------

#### 4.4.0

###### feat:

1. 重构parser，在具体业务启动前解析出AVPacket
2. 本地文件(avs，mp4)播放，支持seek
3. 将默认渲染方式切换为软渲染，提升稳定性

###### fix:

1. 异常数据导致下载中断
2. 抓拍没有写入水印

-------------------------------------------

#### 4.3.1_cs_vms

##### feat:

1. 6005接口适配取消水印、参数默认值、下载时是否开启水印

2. 渲染默认为硬件加速方式，提升画质

3. rtsp交互的超时时间升至30s

4. 语音对讲、广播的rtsp超时时间升至60s

   5. 32位多线程解码导致内存耗尽

#### 4.3.1

##### feat:

1. 添加回调状态, DOWNLOAD_KBYTERATE = 10018, 下载速度(单位:kBps),定时1s回调
2. 适配音频格式动态切换(a/u)
3. 卡顿优化，基于缓冲大小
4. 拼接流严格检测，检测的机制优化为丢包不超过3帧
5. 使用python完成PC端的打包上传(尚待完善)
6. 录像下载兼容帧率不为25的情况

##### fix:

1. 下载返回失败
2. 拼接流进度回调
3. 硬解不支持调节画面质量参数
4. 语音对讲提前检测麦克风设备，防止报错异常
5. 录像分片大小超过int类型，产生溢出，导致不生效
6. 倒放花屏

-------------------------------------------

#### 4.3.0(Stable)：

##### fix:

1. 修复下载导致的内存泄漏，提高了下载功能稳定性

2. 修复硬解码导致电子放大失效

3. 更新版本信息

----------------------------

#### 4.2.9

##### feature:

1. 硬解码取消探测流程，加快初始化速度

##### fix:

1. 水印导致的抓拍崩溃、进度异常

------------------------------

#### 4.2.8

##### feature:

1. 支持IPV6地址

2. 语音广播开启失败、语音广播失败增加详细的错误提示

3. sdp根据编码类型解析上下文

-------------------------------

#### 4.2.7

##### feature:

1. 本地录像、录像下载、抓拍功能使用ffmpeg重构，弃用mov库(mov库录制的MP4文件花屏、不标准无法分享)
2. FFmpeg库重新编译引入drawtext滤镜支撑水印功能，并添加allplayer.ttf以支持中文

------

#### 4.2.6(Stable)

##### fixed:

1. 处理rtp包超过1500字节的情况

2. player建连后将窗口句柄加入集合，防止误用

---------------

#### 4.2.5

##### feature:

1. 语音广播，文件广播

-----------------------------------------------

#### 4.2.4

##### fixed:

1. 初始化硬解码器失败(gpu被禁用时)，自动切换到cpu解码器

2. rtp payload没有匹配的通道时，不更新数据接收时间，可以触发超时

3. 只解码关键帧功能失效

4. 音视频数据解析时内存泄漏

--------------------------

#### 4.2.3

##### fixed:

1. rtsp数据异常，解析失败，导致下载失败或播放报错:媒体流协商失败 
   
   数据异常时等待数据正常，如果8s仍没有解析到正常数据，报20006超时错误

2. 由于没有设置窗口句柄导致下载任务失败

3. socks代理导致语音对讲失效

--------------------------------------

#### 4.2.2

##### fixed:

1. 同时拉取多路时，有一路拉不起来

2. 录像回放倍速导致播放提前结束

3. 软解切换到硬解后窗口失效，渲染不出视频

----------------------------------------------------------------

#### 4.2.1

##### fixed:

1. 适配aac sdp无channel的情况，解决现网视频流协商失败问题

2. 设置画质参数后，暂停视频，花屏

3. setUrl后窗口被占用，无法播放

-----------------------------------------------------------------------------------------------------------------------------

#### 4.2.0

##### feature:

1. socks5方式建立rtsp连接

##### fixed:

1. jpeg解码崩溃

2. 播放htpps url

3. 抓拍功能在硬解码时失效

4. 轮询(多路同时起播)崩溃

5. vcr控制时间偏差
   
   -----------------------------------------------

#### 4.1.0

##### fixed:

1. win7硬件渲染崩溃

2. CPU占用率异常升高

3. 暂停、恢复功能失效

4. 画质优先关闭流导致进程失效

5. 随路语音多路混杂

6. 部分画面绿屏

##### feature:

1. 视频流无缝切换(仅PC)

2. 支持MJPEG编码格式RTP数据解析、解码
   
   ---

#### 4.0.0

1. ffmpeg版本升级至4.4.1，并在此基础上修复灰屏

2. 视频信息统计(丢包率)优化

3. 帧缓冲结构优化

---

#### 3.4.0

1. 单帧播放缓冲优化

2. 画质优先效果优化，缓解录像卡顿

---

#### 3.3.0

1. 各平台支持语音对讲(pc,android,ios)

2. 支持解析拼接流(煤矿项目)

3. 状态码变化
   
   ```
   STREAM__MULTI_FRAGS_MISMATCH = 20017, //拼接流多片段数量不匹配
   
   STREAM_STATUS_TALK_FAIL = 20018, //语音对讲开启失败
   
   STREAM_STATUS_TALK_SUCCESS = 20019, //对讲开启成功
   ```

---

#### 3.2.2

1. 支持aac音频格式解码播放
2. 播放状态下忽略恢复命令

---

#### 3.2.1

1. 优化录像回放位置跳转逻辑，防止时间戳翻转导致的滑动条失控

2. 添加渲染窗口初始化失败定位日志

3. 第一次打开程序时log文件创建失败原因定位：logs路径没有创建

---

#### 3.2.0

1. 支持所有合法url地址的播放(本地文件，rtmp等)，支持多路音频

#### 3.1.0

1. 各平台代码合并

2. setup建连url根据control和content_base确定

---

#### 3.0.0

1. 初始化全局配置时打印版本号

2. 支持64位版本

3. 视频流支持dx11va硬解码,dx11渲染

4. 支持单帧前进和后退

5. 支持图像质量参数设置

6. 新增对avs平台的支持：
   
   1. setup时，control字段适配
   
   2. 下载进度：增加20016连接关闭状态，处理录像下载没有eos导致卡在99%的问题。

7. 修复了录像下载进度异常跳转问题

8. 修复了画质优先下设置音量导致卡死的问题

9. 修复了视频暂停后播放音量异常的问题

----

​
